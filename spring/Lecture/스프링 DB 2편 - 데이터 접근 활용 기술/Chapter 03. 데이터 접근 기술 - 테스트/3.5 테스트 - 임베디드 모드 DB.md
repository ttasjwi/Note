# <a href = "../README.md" target="_blank">스프링 DB 2편 - 데이터 접근 활용 기술</a>
## Chapter 03. 데이터 접근 기술 - 테스트
### 3.5 테스트 - 임베디드 모드 DB
1) H2 데이터베이스의 임베디드 모드 DB 기능
2) H2 데이터베이스 임베디드 모드 수동 설정
3) (실습) 임베디드 DB 상태로 테스트 실행 - 실패
4) 스프링 부트 : 기본 SQL 스크립트를 통해 데이터베이스를 초기화
5) (실습) SQL 스크립트 등록 후 테스트 실행 - 성공

---

# 3.5 테스트 - 임베디드 모드 DB

---

## 1) H2 데이터베이스의 임베디드 모드 DB 기능

### 1.1 굳이 테스트용 DB를 따로 마련할 필요가 없다.
- 테스트 케이스를 실행하기 위해서 별도의 데이터베이스를 설치하고, 운영하는 것은 상당히 번잡한 작업이다.
- 단순히 테스트를 검증할 용도로만 사용하기 때문에 테스트가 끝나면 데이터베이스의 데이터를 모두 삭제해도 된다.
- 더 나아가서 테스트가 끝나면 데이터베이스 자체를 제거해도 된다.

### 1.2 H2 임베디드 모드
- H2 데이터베이스는 자바로 개발되어 있고, JVM 안에서 메모리 모드로 동작하는 특별한 기능을 제공한다.
- 애플리케이션을 실행할 때 H2 데이터베이스도 해당 JVM 메모리에 포함해서 함께 실행할 수 있다.
- DB를 애플리케이션에 내장해서 함께 실행한다고 해서 임베디드 모드(Embedded mode)라 한다.
- 물론 애플리케이션이 종료되면 임베디드 모드로 동작하는 H2 데이터베이스도 함께 종료되고, 데이터도 모두 사라진다.
- 쉽게 이야기해서 H2 임베디드 모드 DB는 애플리케이션에서 자바 메모리를 함께 사용하는 라이브러리처럼 동작하는 것이다.

---

## 2) H2 데이터베이스 임베디드 모드 수동 설정
```java
@Slf4j
//@Import(MemoryConfig.class)
//@Import(JdbcTemplateV1Config.class)
//@Import(JdbcTemplateV2Config.class)
@Import(JdbcTemplateV3Config.class)
@SpringBootApplication(scanBasePackages = "hello.itemservice.web")
public class ItemServiceApplication {

    // 생략
    
	@Bean
	@Profile("test")
	public DataSource dataSource() {
		log.info("메모리 데이터베이스 초기화");
		DriverManagerDataSource dataSource = new DriverManagerDataSource();
		dataSource.setDriverClassName("org.h2.Driver");
		dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");
		dataSource.setUsername("sa");
		dataSource.setPassword("");
		return dataSource;
	}

}
```
- `@Profile("test")`
  - 프로필이 test 인 경우에만 데이터소스를 스프링 빈으로 등록한다.
  - 테스트 케이스에서만 이 데이터소스를 스프링 빈으로 등록해서 사용하겠다는 뜻이다.
- `dataSource()`
  - `jdbc:h2:mem:db` : 이 부분이 중요하다. 데이터소스를 만들때 이렇게만 적으면 임베디드 모드(메모리 모드)로 동작하는 H2 데이터베이스를 사용할 수 있다.
  - `DB_CLOSE_DELAY=-1` : 임베디드 모드에서는 데이터베이스 커넥션 연결이 모두 끊어지면 데이터베이스도 종료되는데, 그것을 방지하는 설정이다.
  - 이 데이터소스를 사용하면 메모리 DB를 사용할 수 있다.

---

## 3) (실습) 임베디드 DB 상태로 테스트 실행 - 실패

### 3.1 H2 데이터베이스 끄기
- 실제 사용 중인 H2 데이터베이스와 무관하게 임베디드 DB가 작동하는 지 확인하기 위해 H2 데이터베이스를 끈다.

### 3.2 테스트 실행 - 실패
```shell
org.springframework.jdbc.BadSqlGrammarException: PreparedStatementCallback; bad
SQL grammar []; nested exception is org.h2.jdbc.JdbcSQLSyntaxErrorException:
Table "ITEM" not found; SQL statement:
insert into item (item_name, price, quantity) values (?, ?, ?) [42102-200]
...
Caused by: org.h2.jdbc.JdbcSQLSyntaxErrorException: Table "ITEM" not found; SQL
statement:
insert into item (item_name, price, quantity) values (?, ?, ?) [42102-200]
```
- 그런데 막상 실행해보면 위와 같은 오류를 확인 할 수 있다.
  - (cf) 오류는 항상 아래에 있는 오류 정보가 더 근본 원인에 가까운 오류 로그이다.
- `Table "ITEM" not found` 이 부분이 핵심이다. 데이터베이스 테이블이 없는 것이다.
- 생각해보면 메모리 DB에는 아직 테이블을 만들지 않았다.
- 테스트를 실행하기 전에 테이블을 먼저 생성해주어야 한다.
  - 수동으로 할 수도 있지만, 스프링 부트는 이 문제를 해결할 아주 편리한 기능을 제공해주므로 아래의 방법을 사용하면 된다.

---

## 4) 스프링 부트 : 기본 SQL 스크립트를 통해 데이터베이스를 초기화

### 4.1 기본 데이터베이스 스크립트 등록
```sql
drop table if exists item CASCADE;
create table item
(
    id        bigint generated by default as identity,
    item_name varchar(10),
    price     integer,
    quantity  integer,
    primary key (id)
);

```
- 메모리 DB는 애플리케이션이 종료될 때 함께 사라지기 때문에, 애플리케이션 실행 시점에 데이터베이스 테이블도 새로 만들어주어야 한다.
- JDBC나 JdbcTemplate를 직접 사용해서 테이블을 생성하는 DDL을 호출해도 되지만, 너무 불편하다.
- 스프링 부트는 SQL 스크립트를 실행해서 애플리케이션 로딩 시점에 데이터베이스를 초기화하는 기능을 제공한다.
- `src/test/resources/schema.sql`에 ddl을 등록해두면 애플리케이션 실행 시점에 테이블을 같이 생성해준다.
  - 데이터를 삽입하는 용도로는 `data.sql`을 사용하면 된다고 함.
- SQL 스크립트를 사용해서 데이터베이스를 초기화하는 자세한 방법은 다음 스프링 부트 공식 메뉴얼을 참고하자.
  - https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto.data-initialization.using-basic-sql-scripts

### 4.2 로깅 설정
```properties
#schema.sql
logging.level.org.springframework.jdbc=debug
```
- jdbc 기준 기본 SQL 스크립트가 잘 실행되는지 로그로 확인하려면 위의 내용이 추가되어 있어야 한다.
  `src/test/resources/application.properties`

---

## 5) (실습) SQL 스크립트 등록 후 테스트 실행 - 성공

```shell
..init.ScriptUtils : 0 returned as update count for SQL: drop table if
exists item CASCADE
..init.ScriptUtils : 0 returned as update count for SQL: create table item
( id bigint generated by default as identity, item_name varchar(10), price
integer, quantity integer, primary key (id) )
```
- `ItemRepositoryTest` 를 실행해보면 드디어 테스트가 정상 수행되는 것을 확인할 수 있다.

---
