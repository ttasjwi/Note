# <a href = "../README.md" target="_blank">스프링 DB 2편 - 데이터 접근 활용 기술</a>
## Chapter 10. 스프링 트랜잭션 전파1 - 기본
### 10.2 스프링 트랜잭션 전파2 - 트랜잭션 두 번 사용

---

# 10.2 스프링 트랜잭션 전파2 - 트랜잭션 두 번 사용

---

## 1) 서로 다른 트랜잭션 커밋, 커밋

### 1.1 `double_commit()`
```java
@Test
public void double_commit() {
    log.info("트랜잭션1 시작");
    TransactionStatus tx1 = txManager.getTransaction(new DefaultTransactionAttribute());
    log.info("트랜잭션1 커밋");
    txManager.commit(tx1);

    log.info("트랜잭션2 시작");
    TransactionStatus tx2 = txManager.getTransaction(new DefaultTransactionAttribute());
    log.info("트랜잭션2 커밋");
    txManager.commit(tx2);
}
```
- 트랜잭션1이 완전히 끝나고나서 트랜잭션2를 수행한다.

### 1.2 로그 확인
```shell
트랜잭션1 시작
Creating new transaction with name [null]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
Acquired Connection [HikariProxyConnection@1080517451 wrapping conn0: url=jdbc:h2:mem:a86ceaa1-3d27-4d17-adfa-57d6713aa74f user=SA] for JDBC transaction
Switching JDBC Connection [HikariProxyConnection@1080517451 wrapping conn0: url=jdbc:h2:mem:a86ceaa1-3d27-4d17-adfa-57d6713aa74f user=SA] to manual commit
트랜잭션1 커밋
Initiating transaction commit
Committing JDBC transaction on Connection [HikariProxyConnection@1080517451 wrapping conn0: url=jdbc:h2:mem:a86ceaa1-3d27-4d17-adfa-57d6713aa74f user=SA]
Releasing JDBC Connection [HikariProxyConnection@1080517451 wrapping conn0: url=jdbc:h2:mem:a86ceaa1-3d27-4d17-adfa-57d6713aa74f user=SA] after transaction

트랜잭션2 시작
Creating new transaction with name [null]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
Acquired Connection [HikariProxyConnection@1676857380 wrapping conn0: url=jdbc:h2:mem:a86ceaa1-3d27-4d17-adfa-57d6713aa74f user=SA] for JDBC transaction
Switching JDBC Connection [HikariProxyConnection@1676857380 wrapping conn0: url=jdbc:h2:mem:a86ceaa1-3d27-4d17-adfa-57d6713aa74f user=SA] to manual commit
트랜잭션2 커밋
Initiating transaction commit
Committing JDBC transaction on Connection [HikariProxyConnection@1676857380 wrapping conn0: url=jdbc:h2:mem:a86ceaa1-3d27-4d17-adfa-57d6713aa74f user=SA]
Releasing JDBC Connection [HikariProxyConnection@1676857380 wrapping conn0: url=jdbc:h2:mem:a86ceaa1-3d27-4d17-adfa-57d6713aa74f user=SA] after transaction
```
#### 트랜잭션1
- `Acquired Connection [HikariProxyConnection@1064414847 wrapping conn0] for JDBC transaction`
  - 트랜잭션1을 시작하고, 커넥션 풀에서 conn0 커넥션을 획득했다.
- `Releasing JDBC Connection [HikariProxyConnection@1064414847 wrapping conn0] after transaction`
  - 트랜잭션1을 커밋하고, 커넥션 풀에 conn0 커넥션을 반납했다.

#### 트랜잭션2
- `Acquired Connection [HikariProxyConnection@1676857380 wrapping conn0] for JDBC transaction`
  - 트랜잭션2을 시작하고, 커넥션 풀에서 conn0 커넥션을 획득했다.
- `Releasing JDBC Connection [HikariProxyConnection@1676857380 wrapping conn0] after transaction`
  - 트랜잭션2을 커밋하고, 커넥션 풀에 conn0 커넥션을 반납했다.



### 1.3 그림으로 확인하는 원리
![img.png](img.png)

![img_1.png](img_1.png)

- 트랜잭션1이 커밋 후 종료되고, 트랜잭션2가 커밋하고 종료되므로 각각 따로 커밋된다.
- 트랜잭션이 각각 수행되면서 사용되는 DB 커넥션도 각각 다르다.
- 이 경우 트랜잭션을 각자 관리하기 때문에 전체 트랜잭션을 묶을 수 없다.

---




- 예를 들어서 트랜잭션1이 커밋하고, 트랜잭션2가 롤백하는 경우 트랜잭션1에서 저장한 데이터는 커밋되고, 트랜잭션2에서 저장한
데이터는 롤백된다. 다음 예제를 확인해보자.


---

## 2) 두 트랜잭션 커밋, 롤백



---
