# <a href = "../README.md" target="_blank">스프링 DB 2편 - 데이터 접근 활용 기술</a>
## Chapter 01. 데이터 접근 기술 - 시작
### 1.6 데이터베이스 테이블 생성
1) Item DDL 및 테이블 생성
2) 테이블 동작 확인
3) 기본키(Primary Key) - 자연키와 대리키
4) 자연키 대신 대리키를 기본키로 사용하자.

---

# 1.6 데이터베이스 테이블 생성

---

## 1) Item DDL 및 테이블 생성
```sql
drop table if exists item CASCADE;
create table item
(
    id        bigint generated by default as identity,
    item_name varchar(10),
    price     integer,
    quantity  integer,
    primary key (id)
);
```
- `generated by default as identity`
  - identity 전략이고 하는데, 기본 키 생성을 데이터베이스에 위임하는 방법이다. (MySQL의 Auto Increment와 같은 방법이다.)
  - 여기서 PK로 사용되는 id 는 개발자가 직접 지정하는 것이 아니라 비워두고 저장하면 된다. 그러면 데이터베이스가 순서대로 증가하는 값을 사용해서 넣어준다.
- 이 DDL 그대로 h2 데이터베이스에 기입하면 테이블을 정상적으로 생성한다.

---

## 2) 테이블 동작 확인
### 2.1 등록
```sql
insert into item(item_name, price, quantity) values ('ItemTest', 10000, 10)
```

### 2.2 조회
```sql
select * from item;
```
- 실행하면 데이터베이스가 생성한 id 값을 포함해서 등록한 데이터가 잘 저장되어 있는 것을 확인할 수 있다.

---

## 3) 기본키(Primary Key) - 자연키와 대리키

### 3.1 기본 키의 조건
- null 허용 x
- 유일해야 한다.
- 변해선 안 된다.

### 3.2 테이블의 기본키 선택 전략
1. 자연키(natural key)
   - 비즈니스에 의미가 있는 키
   - 예: 주민등록번호, 이메일, 사용자 로그인 아이디, 전화번호
2. 대리키(surrogate key)
   - 비즈니스와 관련 없이, 시스템에 의해 임의로 만들어진 키.
   - 대체 키로도 불린다.
   - 예: 오라클 시퀀스, auto_increment, identity, 키생성 테이블 사용

---

## 4) 자연키 대신 대리키를 기본키로 사용하자.

### 4.1 자연키의 위험성
- 될 수 있으면 대리 키의 사용을 권장한다.
- 비즈니스적으로 의미있는 키들은 언젠가 변할 가능성이 매우 높다.
- 예
  - 전화번호는 유일할 수 있지만, null일 수 있고 변경 가능성이 존재해서 기본키로 적당하지 않음.
  - 주민등록번호는 유일하고, null이 아니고 유일하며 변하지 않을 것 같지만 는 3가지 조건을 모두 만족하는 것 같다. 하지만 현실과 비즈니스 규칙은 생각보다 쉽게 변한다. 주민등록번호 조차도 여러 가지 이유로 변경될 수 있다.

### 4.2 김영한님의 사례 : 주민등록번호
- 김영한님의 사례
  - 레거시 시스템을 유지보수할 일이 있었는데, 분석해보니 회원 테이블에 주민등록번호가 기본 키로 잡혀 있었다.
  - 회원과 관련된 수많은 테이블에서 조인을 위 해 주민등록번호를 외래 키로 가지고 있었고 심지어 자식 테이블의 자식 테이블까지 주민등록 번호가 내려가 있었다.
  - 문제는 정부 정책이 변경되면서 법적으로 주민등록번호를 저장할 수 없게 되면서 발생했다.
  - 결국 데이터베이스 테이블은 물론이고 수많은 애플리케이션 로직을 수정 했다.
  - 만약 데이터베이스를 처음 설계할 때부터 자연키인 주민등록번호 대신에 비즈니스와 관련 없는 대리 키를 사용했다면 수정할 부분이 많지는 않았을 것이다.

### 4.3 비즈니스 환경은 언젠가 변하기 마련이다.
- 기본 키의 조건을 현재는 물론이고 미래까지 충족하는 자연 키를 찾기는 쉽지 않다.
- 대리 키는 비즈니스와 무관한 임의의 값이므로 요구사항이 변경되어도 기본 키가 변경되는 일은 드물다.

### 4.4 대리키를 기본키로 사용하자.
- 비즈니스 요구사항은 계속해서 변하는데 테이블은 한 번 정의하면 변경하기 어렵다.
- 그런면에서 외부 풍파에 쉽게 흔들리지 않는 대리 키가 일반적으로 좋은 선택이다.

### 4.5 대신 자연키 후보가 되는 것들은 필요에 따라 유니크 제약조건을 걸어서 사용하자. 
- 대리 키를 기본 키로 사용하되, 주민등록번호나 이메일처럼 자연 키의 후보가 되는 컬럼들은 필요에 따라 유니크 인덱스를 설정해서 사용하는 것을 권장한다.

### 4.6 JPA와 기본키
- JPA는 모든 엔티티에 일관된 방식으로 대리 키 사용을 권장한다.

---
