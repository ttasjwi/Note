# <a href = "../README.md" target="_blank">따라하며 배우는 AWS 네트워크 입문</a>
## Chapter 02. VPC 기초
### 2.5 [실습 2-2] 프라이빗 서브넷 VPC 구성
1) 프라이빗 서브넷 추가
2) 검증
3) 통신 흐름
4) 자원 삭제

---

# 2.5 [실습 2-2] 프라이빗 서브넷 VPC 구성

---

## 1) 프라이빗 서브넷 추가

### 1.1 프라이빗 서브넷 생성
- 서비스 -> 네트워킹 및 콘텐츠 전송 -> VPC -> Virtual Private Cloud -> 서브넷 -> 서브넷 생성
- 생성
    - VPC ID : 앞에서 지정한 VPC
    - 서브넷 이름 : CloudNeta-Private-SN
    - 가용 영역(AZ) : ap-northeast-2c
    - IPv4 블록 : 10.0.1.0/24
- 여기까지 하면 VPC 내에 퍼블릭 서브넷과 프라이빗 서브넷이 존재한다.
- 프라이빗 라우팅 테이블은 아직 기본 라우팅 테이블을 사용한다.(명시적 연결은 되어 있지 않음)

### 1.2 NAT 게이트웨이 생성
- 서비스 -> 네트워킹 및 콘텐츠 전송 -> VPC -> Virtual Private Cloud -> NAT 게이트웨이 -> NAT 게이트웨이 생성
- 생성
  - 이름 : CloudNeta-NAT
  - 서브넷 : **퍼블릭 서브넷**
  - 탄력적 IP 할당
- NAT 게이트웨이는 외부 인터넷 구간과 통신하게 해주는 역할이지만 위치상으로는 퍼블릭 서브넷에 배치되어야 한다.
- NAT 게이트웨이는 바로 사용가능한 상태가 되지 않고, 대기 시간이 필요하므로 사용가능한 상태 될 때까지 대기해야함.

### 1.3 프라이빗 라우팅 테이블 생성 및 서브넷 연결
- 서비스 -> 네트워킹 및 콘텐츠 전송 -> VPC -> Virtual Private Cloud -> 라우팅 테이블 -> 라우팅 테이블 생성
- 생성
    - 이름 : CloudNeta-Private-RT
    - VPC : CloudNeta-VPC(아까 생성한 VPC)
- 서브넷 생성을 확인한다.
- 서블릿 연결 -> 서브넷 연결 편집 -> 위에서 생성했던 서브넷을 지금 만든 라우팅 테이블에 연결한다.
- 이것으로 프라이빗 서브넷이 프라이빗 라우팅 테이블에 연결됐다.

### 1.4 프라이빗 라우팅 테이블 경로 추가
- 서비스 -> 네트워킹 및 콘텐츠 전송 -> VPC -> Virtual Private Cloud -> 라우팅 테이블
- 프라이빗 라우팅 테이블 선택 - 라우팅 - 라우팅 편집 - 라우팅 추가
    - 대상 : 0.0.0.0/0
    - 대상 : NAT 게이트웨이 - (아까 생성한 IGW)
- 이제 프라이빗 서브넷이 NAT 게이트웨이에 연결됐다.

---

## 2) 검증

### 2.1 EC2 인스턴스 생성
- 서비스 -> 컴퓨팅 -> EC2 -> 인스턴스 -> 인스턴스 -> 인스턴스 시작
    - 이름 : Public-EC2
    - AMI : Amazon Linux 2 AMI
    - 인스턴스 유형 : t2.micro
    - 키 페어 : 생성했던 키
    - 네트워크 설정
        - VPC : 아까 생성한 VPC
        - 서브넷 : 아까 생성한 Private 서브넷
        - 퍼블릭 IP 할당 x
        - 보안그룹 : 기본값
    - 스토리지 추가 : 기본값
    - 고급 세부 정보 : http://bit.ly/cnbl0202 의 코드를 그대로 맨 아래 입력창에 텍스트로 기입
      - SSH 접속 시 EC2 인스턴스에 키 페어 없이 root 계정의 암호 입력 방식으로 로그인을 하는 설정이다.

### 2.2 EC2 인스턴스 접근 후 통신 확인
- 퍼블릭 IP를 할당받지 않았기 때문에 바로 접근할 수 없다.
- 퍼블릭 EC2를 통해, 프라이빗 EC2 인스턴스로 SSH 접근을 시도해야한다.
- 퍼블릭 EC2에서 다음을 입력해 ssh 접속한다.
  ```shell
  ssh root@프라이빗_ip
  ```
- 이때 root 계정의 암호를 입력함으로서 private ec2에 접근할 수 있다.
- ping google.com 을 입력하여 통신이 잘 되는지 확인한다.

---

## 3) 통신 흐름

### 3.1 퍼블릭 서브넷 통신 흐름
- 퍼블릭 서브넷의 퍼블릭 EC2 인스턴스가 인터넷 외부 구간과 통신하기 위해 가상 라우터로 전달한다. (public ip 사용)
- 가상 라우터는 퍼블릭 라우팅 테이블을 참고하여 인터넷 게이트 웨이로 향하는 라우팅 경로를 확인한다.
- 가상 라우터는 인터넷 게이트웨이로 데이터를 전달하고, 인터넷 구간으로 넘어간다.
- 인터넷 구간을 통해 결국 사용자에게 전달한다.
- 데이터 흐름이 퍼블릭 서브넷의 퍼블릭 EC2 인스턴스로 향하는 경우, 퍼블릭 IP를 타깃으로 하여 라우팅 되기 때문에 결국 EC2 인스턴스로
라우팅이 된다.

### 3.2 프라이빗 서브넷 통신 흐름
- 프라이빗 서브넷의 프라이빗 EC2 인스턴스가 외부 인터넷 구간과 통신하기 위해 데이터를 가상 라우터로 전달한다.(private ip 사용)
- 가상 라우터는 프라이빗 라우팅 테이블을 참고하여 NAT 게이트웨이로 향하는 라우팅 경로를 확인한다.
- 가상 라우터는 NAT 게이트웨이로 데이터를 전달하고, NAT 게이트웨이에서 프라이빗 IP를 퍼블릭 IP로 전환한다.
- NAT 게이트웨이에서 인터넷 구간을 넘어가기 위해 인터넷 게이트웨이를 거쳐 사용자에게 전달이 된다. 이 때 사용자는 NAT 게이트웨이에서 변환한
퍼블릭 IP로 전달받는다.
- 데이터 흐름이 프라이빗 서브넷의 프라이빗 EC2 인스턴스로 향하는 경우, 사용자 입장에서는 프라이빗 IP만 알고 있으므로 통신이 불가능하다.

---

## 4) 자원 삭제
- EC2 인스턴스 종료 (EC2 -> 인스턴스 -> 인스턴스 선택 -> 작업 -> 인스턴스 삭제 -> 종료)
  - 보안그룹도 함께 제거한다.
- NAT 게이트웨이 삭제 (VPC -> NAT 게이트웨이 -> 작업 -> NAT 게이트웨이 삭제)
- 탄력적 IP 삭제 (VPC -> 탄력적 IP -> Actions -> 탄력적 IP 주소 릴리스)
- VPC 삭제 (VPC -> VPC -> 자원 -> VPC 삭제)
  - 삭제와 함께 하위에 있는 서브넷, 라우팅 테이블, 인터넷 게이트웨이가 사라진다.

---
